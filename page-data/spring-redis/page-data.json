{"componentChunkName":"component---src-templates-post-template-js","path":"/spring-redis/","result":{"data":{"post":{"id":"562a42c3-7b93-5446-98ad-67ca27ba338e","html":"<h3>1. Springboot Redis 세션 클러스터링을 사용하는 이유</h3>\n<ul>\n<li>서버가 한대일 경우 WAS에 세션 정보를 담아두고 사용하면 되지만 서버가 N대로 늘어날 경우 늘어난 서버의 ip, port 정보를 N대의 서버에 일일이 입력해줘야 한다. 따라서 WAS가 제공하는 세션 클러스터링 기능에 의존하지 않고 새로운 저장소를 두고 세션 정보를 두고 공유하게 되면 서버가 늘어나도 저장소 정보만 공유해주면 된다.</li>\n<li>세션을 공유하기 위한 저장소로는 Redis를 많이 이용한다. Redis는 데이터 저장소로 가장 I/O 속도가 빠른 장치인 메모리를 사용하고 있고 구조적으로는 key, value 형식의 데이터 처리에 특화되어 있다.</li>\n</ul>\n<h3>2. 세션 공유 시나리오</h3>\n<ul>\n<li>각각의 서버에는 웹어플리케이션 1, 2, 3, 이 있고 각각의 세션은 연동되어 한 곳에서 로그인 시에 다른 웹어플리케이션과 세션을 공유하여 로그인/ 로그아웃 처리를 해야 한다.</li>\n<li>웹어플리케이션이 1,2,3있는 서버 N대가 있고 앞쪽에서 L4나 nginx, HAproxy등으로 부하분산 처리를 해주고 N대의 서버는 세션을 공유 하여 로그인 / 로그아웃을 처리 해야 한다.</li>\n</ul>\n<h3>3. Redis 설치 및 서비스 등록</h3>\n<ul>\n<li>Redis는 공식적으로 윈도우를 지원하지 않고, <a href=\"https://github.com/MicrosoftArchive/redis/releases\">MSOpenTech</a>라는 곳에서 지속적으로 윈도우 버전을 릴리즈 하고 있다.</li>\n<li>별도의 인스톨은 필요하지 않고 해당 zip파일을 받아서 conf파일을 각자의 설정에 맞게 수정 후 서비스로 등록 후 시작해주면 된다.</li>\n<li>기본포트는 6379번이고 포트를 포함한 설정정보를 수정하려면 redis.windows.conf 파일을 수정하면 된다.</li>\n<li>\n<p>서비스를 등록하고 redis 서비스를 시작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">redis-server --service-install redis.windows.conf --loglevel verbose\nredis-server --service-start</code></pre></div>\n</li>\n<li>cli로 접속하여 정상적으로 접속이 되는지 확인.(아직 springboot에 redis 설정을 하지 않았으므로 아무것도 없다.)</li>\n<li>\n<p>redis-cli</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *\n<span class=\"token punctuation\">(</span>empty list or <span class=\"token builtin class-name\">set</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>flushall : 모든 세션 정보 초기화</li>\n<li>keys * : 모든 세션 정보 조회</li>\n<li>get “key” : 해당 키의 세션 정보 조회</li>\n</ul>\n<h3>4. build.gradle 설정</h3>\n<ul>\n<li>\n<p>redis session을 사용 할 수 있도록 디펜던시 추가</p>\n<div class=\"gatsby-highlight\" data-language=\"properties\"><pre class=\"language-properties\"><code class=\"language-properties\"><span class=\"token attr-name\">compile('org.springframework.session</span><span class=\"token punctuation\">:</span><span class=\"token attr-value\">spring-session-data-redis')</span></code></pre></div>\n</li>\n</ul>\n<h3>5. RedisConfig 파일 추가</h3>\n<ul>\n<li>redis 연결정보와 RedisTemplate을 Bean으로 추가한다.</li>\n<li>\n<p>redisConnectionFactory로는 Jedis 보다 Lettuce가 더 낫다는 글들이 많아서 Lettuce 사용.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@EnableRedisRepositories</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token annotation punctuation\">@Bean</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisConnectionFactory</span> <span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">LettuceConnectionFactory</span> lettuceConnectionFactory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LettuceConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> lettuceConnectionFactory<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Bean</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setKeySerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setValueSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Jackson2JsonRedisSerializer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyDto</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<h3>6. Session에 담아줄 Dto에 Serializable 추가</h3>\n<ul>\n<li>Dto를  Serializable 하지 않을 경우 다음과 같은 에러가 발생하니 꼭 Serializable을 추가해야한다.</li>\n<li><strong>DefaultSerializer requires a Serializable payload but received an object of type [MyDto]</strong></li>\n<li>웹어플리케이션 1,2,3에서 세션을 공유해야 하기 때문에 각 어플리케이션의 serialVersionUID는 동일하게 설정해야 한다.</li>\n</ul>\n<h3>7. session 확인 후 로그인 처리</h3>\n<ul>\n<li>\n<p>웹 어플리케이션에 로그인시에 해당 session을 redis 설정한 어플리케이션끼리 공유하므로 session 정보를 확인 후 로그인 처리 또는 login페이지로 이동하도록 설정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Controller</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LoginController</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token comment\">/**\n* 로그인 화면\n* @return\n*/</span>\n<span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Model</span> model<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">//사용자 정보가 있을 경우 바로 메인 페이지로 이동</span>\n    <span class=\"token class-name\">MyDto</span> session <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">MyDto</span><span class=\"token punctuation\">)</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyDto</span><span class=\"token punctuation\">.</span>KEY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>session <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"redirect:/main/\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    model<span class=\"token punctuation\">.</span><span class=\"token function\">addAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"loginForm\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyDto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"/login/login\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<h3>8. 확인</h3>\n<ul>\n<li>각 어플리케이션에서 다른 어플리케이션으로 접속시 세션이 공유되어 로그인/로그아웃이 정상적으로 되는지 확인</li>\n</ul>","fields":{"slug":"/spring-redis/","prefix":"2019-11-08"},"frontmatter":{"title":"Springboot Redis 세션 공유","category":"spring"}},"authornote":{"id":"8b2419cd-9b30-5409-9d2c-da10779777d4","html":"<p><strong>OpenSesame</strong></p>\n<ul>\n<li>안되면 될 때 까지!</li>\n<li>무분별한 정보 보다는 정확한 정보를 전달하도록 노력하기.</li>\n</ul>"}},"pageContext":{"slug":"/spring-redis/","prev":{"id":"3b2e53d1-1a84-5781-8257-8e5363733059","fields":{"slug":"/ubuntu-jdk/","prefix":"2019-08-18","source":"posts"},"frontmatter":{"title":"Ubuntu java 버전 변경하기","category":"infra"}},"next":{"id":"c0b56cd9-7947-5c53-bc4e-92ececba716e","fields":{"slug":"/vscode-static-import/","prefix":"2019-12-05","source":"posts"},"frontmatter":{"title":"vscode lombok & static import 설정","category":"ide"}},"source":"posts"}},"staticQueryHashes":["960164547","960164547"]}