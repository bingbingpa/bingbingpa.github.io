<!DOCTYPE html><html lang="ko" prefix="og: http://ogp.me/ns#"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.af1934050e65245c9772.css" id="gatsby-global-css">@font-face{font-family:Open Sans;font-style:normal;font-display:swap;font-weight:300;src:local("Open Sans Light "),local("Open Sans-Light"),url(/static/open-sans-latin-300-60c866748ff15f5b347fdba64596b1b1.woff2) format("woff2"),url(/static/open-sans-latin-300-521d17bc9f3526c690e8ada6eee55bec.woff) format("woff")}@font-face{font-family:Open Sans;font-style:italic;font-display:swap;font-weight:300;src:local("Open Sans Light italic"),local("Open Sans-Lightitalic"),url(/static/open-sans-latin-300italic-06bbd3188b34820cd83a0e0b3d0a6f57.woff2) format("woff2"),url(/static/open-sans-latin-300italic-8a648ff38ded89ea15916e84529d62d3.woff) format("woff")}@font-face{font-family:Open Sans;font-style:normal;font-display:swap;font-weight:400;src:local("Open Sans Regular "),local("Open Sans-Regular"),url(/static/open-sans-latin-400-cffb686d7d2f4682df8342bd4d276e09.woff2) format("woff2"),url(/static/open-sans-latin-400-bf2d0783515b7d75c35bde69e01b3135.woff) format("woff")}@font-face{font-family:Open Sans;font-style:italic;font-display:swap;font-weight:400;src:local("Open Sans Regular italic"),local("Open Sans-Regularitalic"),url(/static/open-sans-latin-400italic-987032ea5d57c93d8da215678eae3b86.woff2) format("woff2"),url(/static/open-sans-latin-400italic-db70d0b9cb27ada1a260a2b35e756b8b.woff) format("woff")}@font-face{font-family:Open Sans;font-style:normal;font-display:swap;font-weight:600;src:local("Open Sans SemiBold "),local("Open Sans-SemiBold"),url(/static/open-sans-latin-600-223a277bd88d8a90c8cdf24cda0ad5f5.woff2) format("woff2"),url(/static/open-sans-latin-600-1cd5320f8937d337b61d5117cf9d7b28.woff) format("woff")}@font-face{font-family:Open Sans;font-style:italic;font-display:swap;font-weight:600;src:local("Open Sans SemiBold italic"),local("Open Sans-SemiBolditalic"),url(/static/open-sans-latin-600italic-4950a7205f0b5cefe41fc03ac346e236.woff2) format("woff2"),url(/static/open-sans-latin-600italic-318ea1ada4102c0704a0637228dcad03.woff) format("woff")}@font-face{font-family:Open Sans;font-style:normal;font-display:swap;font-weight:700;src:local("Open Sans Bold "),local("Open Sans-Bold"),url(/static/open-sans-latin-700-d08c09f2f169f4a6edbcf8b8d1636cb4.woff2) format("woff2"),url(/static/open-sans-latin-700-623e3205570002af47fc2b88f9335d19.woff) format("woff")}@font-face{font-family:Open Sans;font-style:italic;font-display:swap;font-weight:700;src:local("Open Sans Bold italic"),local("Open Sans-Bolditalic"),url(/static/open-sans-latin-700italic-c02f5da6e82e1efe0b45841bfd49ce37.woff2) format("woff2"),url(/static/open-sans-latin-700italic-72e19cbb0e38c6773a7751156752cec4.woff) format("woff")}@font-face{font-family:Open Sans;font-style:normal;font-display:swap;font-weight:800;src:local("Open Sans ExtraBold "),local("Open Sans-ExtraBold"),url(/static/open-sans-latin-800-aaeffaf205b9bbb09920089a14dbe9e8.woff2) format("woff2"),url(/static/open-sans-latin-800-c6aa0c4a601fb6ac66f8253fa594dff5.woff) format("woff")}@font-face{font-family:Open Sans;font-style:italic;font-display:swap;font-weight:800;src:local("Open Sans ExtraBold italic"),local("Open Sans-ExtraBolditalic"),url(/static/open-sans-latin-800italic-6b3973ffe02bb6a8be0f8453506ec032.woff2) format("woff2"),url(/static/open-sans-latin-800italic-79b58175343190550489efe46a7f1138.woff) format("woff")}.footer{background:#fff;padding:0 20px 120px}.footer ul{list-style:none;text-align:center;padding:0}.footer ul li{color:#969492;font-size:.8em;padding:2px 10px;position:relative;display:inline-block}.footer ul li:after{content:"\2022";position:absolute;right:-5px}.footer ul li:last-child:after{content:""}@media screen and (min-width:1024px){.footer{padding:0 1em 1.5em}}.item,.showItem{background:transparent;transition:all .5s;display:flex;align-items:center}.item a,.showItem a{padding:10px;display:flex;align-items:center}.item svg,.showItem svg{margin:0 5px 0 0;opacity:.3}.itemList .hideItem{display:none}@media screen and (min-width:1024px){.item a{color:#3e3e3c;padding:10px;transition:all .5s;border-radius:5px}.homepage:not(.fixed) .item a{color:#fff}.item a:hover{color:#709425;background:hsla(0,0%,100%,.4)}.item svg{transition:all .5s}.item:hover svg{fill:#709425;opacity:1}.hero .item:hover svg svg{fill:green}.showItem{display:none}.hiddenItem{text-align:left;padding:5px}.hiddenItem a.inHiddenItem{color:#3e3e3c}.hiddenItem a.inHiddenItem:hover{color:#709425}}.more{cursor:pointer}@media screen and (max-width:1023px){.more{background:#fff;border-radius:5px 5px 0 0;border:1px solid #709425;border-bottom:none;position:absolute;left:50%;top:-35px;width:60px;height:36px;overflow:hidden;z-index:1;-webkit-transform:translateX(-50%);transform:translateX(-50%)}.more:focus{outline:none}.more:focus svg{fill:#709425}.more svg{transition:all .5s;-webkit-transform:rotate(180deg);transform:rotate(180deg);fill:orange}.open .more svg{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}@media screen and (min-width:1024px){.more{flex-shrink:0;flex-grow:0;width:44px;height:38px;background:transparent;margin-left:10px;border-radius:5px;border:1px solid #ecebea;display:flex;transition:background-color .5s;justify-content:center;align-items:center;padding:0;z-index:1}.more:focus,.more:hover{outline:none}.more svg{transition:all .5s}.homepage .more{border:1px solid transparent;background-color:color(#fff opacity(-90%))}.homepage .more:hover{background-color:color(#fff opacity(-60%))}.open .more{background-color:color(#fff opacity(-10%));border-bottom-left-radius:0;border-bottom-right-radius:0}.open .more:hover{background-color:hsla(0,0%,100%,.1)}.open .more svg{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fixed .more{border:1px solid #ecebea;height:30px}}.menu{align-items:center;background:#fff;bottom:0;flex-grow:1;left:0;padding:0 10px;position:fixed;z-index:1;transition:all .5s}.itemList,.menu{display:flex;width:100%}.itemList{flex-wrap:wrap;justify-content:center;list-style:none;margin:0;padding:0;position:relative}@media screen and (max-width:1023px){.menu:after{position:absolute;content:"";left:20px;right:20px;top:0;height:1px;background:#709425}.menu.open{padding:20px}.homepage:not(.fixed) .menu{bottom:-100px}}@media screen and (min-width:1024px){.menu{border-top:none;background:transparent;display:flex;position:relative;padding-left:50px;transition:none}.itemList,.menu{justify-content:flex-end}.itemList{padding:0}.hiddenItemList{list-style:none;margin:0;position:absolute;background:#fff;border:1px solid #ecebea;top:48px;right:10px;display:flex;flex-direction:column;justify-content:flex-start;padding:20px;border-radius:5px 0 5px 5px}.hiddenItemList:after{content:"";background:#fff;z-index:10;top:-10px;right:-1px;width:44px;height:10px;position:absolute;border-left:1px solid #ecebea;border-right:1px solid #ecebea}.homepage:not(.fixed) .hiddenItemList{border:1px solid transparent;background:color(#fff opacity(-10%));top:50px}.homepage:not(.fixed) .hiddenItemList:after{top:-11px;border-left:1px solid transparent;border-right:1px solid transparent;background:color(#fff opacity(-10%))}.fixed .hiddenItemList{top:44px}}.header{justify-content:center;background-color:#fff;height:80px;position:relative;top:0;width:100%}.header,.header a.logoType{align-items:center;display:flex}.header a.logoType{flex-direction:"column";color:#3e3e3c}.header a.logoType .logo{flex-shrink:0}.header.homepage{position:absolute;background-color:transparent;height:100px}.h1-header{font-size:1.35em;font-weight:400;margin:0 0 5px}.h2-header{font-weight:400;font-size:.8em;letter-spacing:0;margin:0}.logo{border-radius:65% 75%;border:1px solid #eee;display:inline-block;height:44px;margin:0 20px 0 0;overflow:hidden;width:44px;transition:all .5s}.homepage .logo{height:60px;width:60px}.logo img{width:100%}.sensor-homepage{top:100px}.sensor-default,.sensor-homepage{display:block;position:absolute;bottom:0;z-index:1;left:0;right:0;height:1px}.sensor-default{top:80px}@media screen and (min-width:600px){.header{padding:40px}.header.homepage{height:100px}}@media screen and (max-width:1023px){.header.homepage .logo{border:none}.header.homepage .h1-header,.header.homepage a.logoType{color:#fff}.header.homepage .h2-header{color:#dddbda}}@media screen and (min-width:1024px){.header{align-items:center;display:flex;position:absolute;justify-content:space-between;transition:padding .5s}.header,.header.fixed{background-color:#fff;top:0;width:100%}.header.fixed{height:50px;left:0;padding:0 20px;position:fixed;z-index:1}.header.fixed .h1-header{margin:0 0 2px}.header.fixed .h2-header{display:none}.header.homepage:not(.fixed) .h1-header,.header.homepage:not(.fixed) a.logoType{color:#fff}.header.homepage:not(.fixed) .h2-header{color:#dddbda}.header a.logoType{text-align:left;flex-direction:row;flex-shrink:0;width:auto}.logo{margin:0 20px 0 0}.fixed .logo{height:36px;width:36px}.header.homepage:not(.fixed) .logo{border:none}h2{-webkit-animation-duration:.5s;animation-duration:.5s;-webkit-animation-name:h2Entry;animation-name:h2Entry}@-webkit-keyframes h2Entry{0%{opacity:0}to{opacity:1}}@keyframes h2Entry{0%{opacity:0}to{opacity:1}}}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit;margin:0;padding:0}body{font-family:Open Sans,sans-serif}body h1,body h2,body h3{font-weight:600;line-height:1.1;letter-spacing:-.03em;margin:0}body h1{letter-spacing:-.04em}body p{margin:0}body strong{font-weight:600}body a{text-decoration:none;color:#666}body main{width:auto;display:block;min-height:80vh}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.article{padding:20px;margin:0 auto}@media screen and (min-width:600px){.article{padding:20px 40px;max-width:650px}}@media screen and (min-width:1024px){.article{padding:130px 0 40px;max-width:700px}}.h1-headline{font-size:2.2em;margin:0 0 40px;-webkit-animation-name:headlineEntry;animation-name:headlineEntry;-webkit-animation-duration:1s;animation-duration:1s}.h1-headline span{font-weight:400;display:block;font-size:.5em;letter-spacing:0;margin:0 0 5px}.h1-headline svg{height:.75em;fill:#709425}@-webkit-keyframes headlineEntry{0%{opacity:.5}to{opacity:1}}@keyframes headlineEntry{0%{opacity:.5}to{opacity:1}}@media screen and (min-width:600px){.h1-headline{font-size:2.4em}}@media screen and (min-width:1024px){.h1-headline{font-size:2.8em}}.ul-list{margin:0 0 20px;padding:20px;list-style:circle}.li-list{padding:5px 0;font-size:1.1em;line-height:1.4}.h2-category{margin:0 0 .5em}.h2-category svg{height:.8em;fill:#709425}.form-search{border-bottom:1px solid #aaa}.form-search,.input-search{position:relative;display:flex;justify-content:space-between}.input-search{border:0;width:100%;padding:.2em;font-size:1.4em;flex-grow:1}.link{width:100%;color:#3e3e3c}.li-item{border:1px solid transparent;border-radius:10px;margin:40px 0 60px;padding:10px;position:relative;transition:all .5s;background:transparent}.li-item .gatsby-image-outer-wrapper{border-radius:10px;border:1px solid #ecebea;overflow:hidden}.li-item .gatsby-image-outer-wrapper img{z-index:-1}.li-item:after{bottom:-30px}.li-item:after,.li-item:first-child:before{border-top:1px solid #ecebea;content:"";height:0;position:absolute;left:50%;-webkit-transform:translateX(-50%);transform:translateX(-50%);transition:all .5s;width:50%}.li-item:first-child:before{top:-30px}.h1-item{padding:20px 10px 0;line-height:1.1;font-size:1.7em;text-remove-gap:both}.h1-item .arrow{display:none;position:relative;top:7px}.item-meta{display:flex;flex-flow:row wrap;font-size:.8em;padding:20px 10px;background:transparent}.item-meta svg{fill:#709425;margin:0 5px 0 0}.item-meta span{align-items:center;display:flex;text-transform:uppercase;margin:5px 10px 5px 0}.item-excerpt{line-height:1.5;padding:0 10px;text-remove-gap:both}@media screen and (min-width:600px){.li-item{padding:20px}.li-item:after{bottom:-40px}.li-item:first-child:before{top:-35px}.h1-item{font-size:2.04em;padding:30px 20px 0;transition:all .5s}.item-meta{padding:30px 20px}.item-excerpt{padding:0 20px}}@media screen and (min-width:1024px){.li-item{padding:0 0 40px}.li-item:after{bottom:-30px}.blogItemLink:first-child>li:before,.li-item:first-child:before{top:-55px}.h1-item{font-size:2.5em;padding:24px 40px 0}.item-meta{padding:30px 40px 10px}.item-excerpt{padding:0 40px}.li-item:hover{border:1px solid #ecebea;box-shadow:0 3px 2px rgba(0,0,0,.03)}.li-item:hover:after{bottom:-50px}.li-item:hover .gatsby-image-wrapper{-webkit-transform:scale(1.1);transform:scale(1.1)}.li-item:hover .h1-item{color:#709425}.li-item:hover .arrow{opacity:1;stroke:orange;-webkit-transform:translateX(0);transform:translateX(0)}.li-item .arrow,.li-item .gatsby-image-wrapper{transition:all .5s}.li-item .arrow{display:inline-block;fill:orange;stroke:orange;stroke-width:40;stroke-linecap:round;opacity:0;-webkit-transform:translateX(-50%);transform:translateX(-50%)}}.main{padding:0 20px}.blog-ul{list-style:none;margin:0 auto;padding:30px 0 10px}@media screen and (min-width:601px){.main{padding:0 0 30px}.blog-ul{max-width:650px}}@media screen and (min-width:1025px){.blog-ul{max-width:700px}}.icon{display:flex;justify-content:flex-end;margin-bottom:20px}.icon svg{height:30px}.bodytext{-webkit-animation-name:bodytextEntry;animation-name:bodytextEntry;-webkit-animation-duration:1s;animation-duration:1s}.bodytext h2,.bodytext h3{margin:1.5em 0 1em}.bodytext h2{line-height:1.2;font-size:1.7em}.bodytext h3{font-size:1.35em;line-height:1.3}.bodytext p{font-size:1.1em;line-height:1.6;margin:0 0 1.5em}.bodytext ul{list-style:circle;margin:0 0 1.5em;padding:0 0 0 1.5em}.bodytext li{margin:.7em 0;line-height:1.5}.bodytext a{font-weight:600;color:#709425;text-decoration:underline}.bodytext a.gatsby-resp-image-link{display:block;margin:2.5em 0;border-radius:10px;overflow:hidden;border:1px solid #ecebea}.bodytext code.language-text{background:#ecebea;text-shadow:none;color:inherit;padding:.1em .3em .2em;border-radius:.1em}@-webkit-keyframes bodytextEntry{0%{opacity:0}to{opacity:1}}@keyframes bodytextEntry{0%{opacity:0}to{opacity:1}}.meta{display:flex;flex-flow:row wrap;font-size:1em;margin:20px 0;background:transparent}.meta svg{fill:#709425;margin:0 5px 0 0}.meta .span-meta{align-items:center;display:flex;text-transform:uppercase;margin:5px 10px 5px 0}@media screen and (min-width:600px){.meta{margin:30px 0 20px}}.author{margin:40px 0;padding:40px 0;border-top:1px solid #ecebea;border-bottom:1px solid #ecebea}.avatar{float:left;border-radius:65% 75%;border:1px solid #ecebea;display:inline-block;height:50px;margin:5px 20px 0 0;overflow:hidden;width:50px}.avatar img{width:100%}.note{font-size:.9em;line-height:1.6}@media screen and (min-width:600px){.author{display:flex}.avatar{flex:0 0 auto}}.links{flex-direction:column;padding:0 20px 40px;border-bottom:1px solid #ecebea;margin:0 0 40px}.links,.links a{display:flex}.links a:nth-child(2){margin:20px 0 0}.links svg{fill:orange;width:20px;height:20px;flex-shrink:0;flex-grow:0;margin:20px}h4{font-weight:600;margin:0;font-size:1.1em}time{color:#969492;display:block;font-weight:400;font-size:.8em;margin-top:.5em}@media screen and (min-width:1024px){.links{flex-direction:row-reverse;justify-content:center}.links a{flex-basis:50%}.links a:nth-child(2){margin:0}.links svg{transition:all .5s;margin:10px}}@media screen and (min-width:1024px) and (hover:hover){.links a:hover svg{-webkit-transform:scale(1.5);transform:scale(1.5)}}@media (max-width:768px){.matrix{width:100%}}.hero{align-items:center;display:flex;justify-content:center}.button-matrix{position:absolute;top:80%;background:#709425;border:0;border-radius:50%;font-size:1.35em;padding:10px 20px;cursor:pointer;width:80px;height:80px}.button-matrix:focus{outline-style:none;background:#709425}.button-matrix svg{position:relative;top:5px;fill:#fff;stroke-width:40;stroke:#fff;-webkit-animation-duration:1s;animation-duration:1s;-webkit-animation-name:buttonIconMove;animation-name:buttonIconMove;-webkit-animation-iteration-count:infinite;animation-iteration-count:infinite}@-webkit-keyframes buttonIconMove{0%{-webkit-transform:translateY(0);transform:translateY(0)}50%{-webkit-transform:translateY(-10px);transform:translateY(-10px)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes buttonIconMove{0%{-webkit-transform:translateY(0);transform:translateY(0)}50%{-webkit-transform:translateY(-10px);transform:translateY(-10px)}to{-webkit-transform:translateY(0);transform:translateY(0)}}.hr-index{margin:0;border:0}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="canonical" href="https://bingbingpa.github.io/postgresql-high-availability/" data-baseprotocol="https:" data-basehost="bingbingpa.github.io"/><title data-react-helmet="true">postgreSQL 고가용성 - 삽질 저장소</title><meta data-react-helmet="true" name="description" content="삽질한 내용들을 정리하는 블로그"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0"/><meta data-react-helmet="true" http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:title" content="postgreSQL 고가용성 - 삽질 저장소"/><meta data-react-helmet="true" property="og:description" content="삽질한 내용들을 정리하는 블로그"/><meta data-react-helmet="true" property="og:image" content="preview.jpg"/><meta data-react-helmet="true" property="og:url" content="https://bingbingpa.github.io/postgresql-high-availability/"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="google-site-verification" content="05n7EQOUWLW-NVaGmvLtb2mFwNCQlApz6zHbZyGwW58"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#666"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link as="script" rel="preload" href="/webpack-runtime-3d61ad746ed8c6156b20.js"/><link as="script" rel="preload" href="/framework-acd7498685eeb36e39da.js"/><link as="script" rel="preload" href="/1bfc9850-d06e3c25ea137ea82c47.js"/><link as="script" rel="preload" href="/app-12eff7a04d58f71d6664.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/3df72598ed628fa3b584613cd093848b9c087970-7e8ab1b1cd93282549c1.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-b9b09e01660a2cb702b9.js"/><link as="fetch" rel="preload" href="/page-data/postgresql-high-availability/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/960164547.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/960164547.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="#D0E0D8"/><meta name="apple-mobile-web-app-title" content="Lazywill"/><link rel="apple-touch-icon" href="/icons/apple-icon-57x57.png" sizes="57x57"/><link rel="apple-touch-icon" href="/icons/apple-icon-60x60.png" sizes="60x60"/><link rel="apple-touch-icon" href="/icons/apple-icon-72x72.png" sizes="72x72"/><link rel="apple-touch-icon" href="/icons/apple-icon-76x76.png" sizes="76x76"/><link rel="apple-touch-icon" href="/icons/apple-icon-114x114.png" sizes="114x114"/><link rel="apple-touch-icon" href="/icons/apple-icon-120x120.png" sizes="120x120"/><link rel="apple-touch-icon" href="/icons/apple-icon-144x144.png" sizes="144x144"/><link rel="apple-touch-icon" href="/icons/apple-icon-152x152.png" sizes="152x152"/><link rel="apple-touch-icon" href="/icons/apple-icon-180x180.png" sizes="180x180"/><link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><header class="header  "><a class="logoType" href="/"><div class="logo"><img src="https://avatars.githubusercontent.com/u/6446144?v=4" alt="삽질저장소"/></div><div class="type"><h1 class="h1-header">삽질저장소</h1><h2 class="h2-header"></h2></div></a><nav class="menu " rel="js-menu"><ul class="itemList"><li class="item"><a class="" data-slug="/" href="/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg> <!-- -->Home</a></li><li class="item"><a class="" data-slug="/category/" href="/category/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg> <!-- -->Categories</a></li><li class="item"><a class="" data-slug="/search/" href="/search/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg> <!-- -->Search</a></li><li class="item"><a class="" data-slug="/about/" href="/about/"> <!-- -->About</a></li></ul></nav></header><div class="sensor-default"></div><main><article class="article"><header><h1 class="h1-headline">postgreSQL 고가용성</h1><p class="meta"><span class="span-meta"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" size="18" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg> <!-- -->2020-05-31</span><span class="span-meta"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" size="18" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg><a href="/category/databse">databse</a></span></p></header><div class="bodytext"><h3>1. 정의</h3>
<ul>
<li>고가용성(HA, High Availability)이란 서버와 네트워크, 프로그램 등의 정보 시스템이 상당히 오랜 기간 동안 지속적으로 정상 운영이 가능한 성질을 말한다.</li>
<li><strong>데이터를 수정할 수있는 서버</strong>를 read/writer, <strong>master</strong>, primary server 라고 한다.</li>
<li><strong>master 의 변경 사항을 추적 하는 서버</strong>를 <strong>standby</strong>, secondary server 라고 한다.</li>
<li><strong>마스터 서버로 승격 될 때까지 연결할 수없는 대기 서버를 warm standby server 라고 하며, 연결을 허용 하고 읽기 전용 쿼리를 제공 하는 서버를 hot standby server 라고 한다.</strong></li>
<li>일부 솔루션은 동기식이므로 모든 서버가 트랜잭션을 커밋 할 때까지 데이터 수정 트랜잭션이 커밋 된 것으로 간주되지 않는다. 이렇게하면 장애 조치 (failover)시 데이터를 잃지 않고 모든 부하 분산 서버가 쿼리 한 서버에 상관없이 일관된 결과를 반환한다.</li>
<li>반대로 비동기 솔루션을 사용하면 커밋 시간과 다른 서버로의 전파 사이에 약간의 지연이 발생하여 백업 서버로 전환 할 때 일부 트랜잭션이 손실 될 수 있으며, 로드 밸런싱 된 서버가 약간 오래된 결과를 반환 할 수 있습니다. 비동기 통신은 동기화가 너무 느릴 때 사용된다.</li>
</ul>
<h3>2. 여러 해결 기법 비교</h3>
<ul>
<li>
<p>Shared Disk Failover</p>
<ul>
<li>하나의 디스크에 여러개의 Postgres 인스턴스를 사용하며, master 서버가 망가지면 대기하던 서버가 해당 디스크를 마운트해서 사용한다.</li>
<li>master 서버가 실행 중일 때 대기 서버가 공유 스토리지에 절대 액세스하지 않아야 한다.</li>
<li><strong>고가의 SAN 스토리지를 사용 하거나 그보다 좀 저렴한 iscsi 스토리지를 사용한다.</strong></li>
<li><strong>NAS 기반 nfs 파일 시스템을 데이터 저장 공간으로는 절대로 사용하지 않는 것이 관례이다.</strong> nfs 파일 시스템은 잦은 읽기 쓰기 환경에서는 속도와 안전성을 보장하지 않기 때문이다.</li>
</ul>
</li>
<li>
<p>File System(Block Device) Replication</p>
<ul>
<li>파일 시스템 레벨의 복제</li>
<li>standby 서버에 대한 write 는 master 서버와 동일한 순서대로 수행 되어야 한다.</li>
<li>주로 DRBD(Distributed Replication Block Device) 라는 Linux 용 파일 시스템 복제 솔루션을 사용한다.</li>
</ul>
</li>
<li>
<p>Write-Ahead Log Shipping</p>
<ul>
<li>WAL : 데이터 무결성을 보장하는 표준 방법이며, 데이터베이스의 변경 내용을 기록하는 파일이다. wal 파일은 pg_waldump 명령어로 읽을 수 있다.

  <a
    class="gatsby-resp-image-link"
    href="/static/4fca4fcb804a434241cc69d6cb1ae075/fe238/wal-file.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 26%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAw0lEQVQY0zWQWQqFQAwEPYAgbrjvirvi/Q/Xj8pjPpoMk6TSibcsi6qqUtu2pjzPVZal0jRV3/d631fzPIu6uq41TZOaplGWZUqSxOoQ7zAM5VEYRZHGcbQGiouiUBzHBnyex3Lf9xn4ui6DIvLbtmldVw3D8AeScM04dUAmdl2n+76t2MV93y06HcdhUIYakAcOAeIQAXQr45BG59Q55M3/eZ4GpTYIAnnY5W4kHQjhGjjTuS0Rx6xNRGzj7gvD9339APHQiBUlXxNvAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="walFile"
        title=""
        src="/static/4fca4fcb804a434241cc69d6cb1ae075/5a190/wal-file.png"
        srcset="/static/4fca4fcb804a434241cc69d6cb1ae075/772e8/wal-file.png 200w,
/static/4fca4fcb804a434241cc69d6cb1ae075/e17e5/wal-file.png 400w,
/static/4fca4fcb804a434241cc69d6cb1ae075/5a190/wal-file.png 800w,
/static/4fca4fcb804a434241cc69d6cb1ae075/c1b63/wal-file.png 1200w,
/static/4fca4fcb804a434241cc69d6cb1ae075/fe238/wal-file.png 1401w"
        sizes="(max-width: 800px) 100vw, 800px"
      />
    </span>
  </span>
  
  </a>
    </li>
<li><strong>WAL(트랜잭션 로그)를 스트리밍이나 파일 기반으로 전달해서 standby 서버를 동기화 한다.</strong></li>
<li><strong>standby 서버를 hot standby server(읽기 전용 쿼리를 제공 하는 서버)로 만들어 추가적으로 활용 할 수 있다.</strong></li>
<li>
<p>WAL file log shipping : WAL 파일 자체를 standby 서버로 전송한다.(file copy)</p>
<ul>
<li>master 서버에 지정된 WAL 파일의 크기를 다 채워야 standby 서버로 전송이 일어나기 때문에, 만약 WAL 파일을 다 채우지 못한 상태에서 master 서버에 장애가 발생하면 WAL 파일을 다 채우지 못해서 전달되지 못한 로그는 유실된다.</li>
</ul>
</li>
<li>
<p>streaming log shipping : WAL 파일 저장 여부와 관계 없이 로그 내용을 standby 서버로 직접 전달한다.</p>
<ul>
<li>master, standby 서버간의 네트워크에 문제가 없다는 가정하에 거의 실시간으로 동작한다.</li>
<li>wal<em>keep</em>segements 값에 따라 WAL 파일의 저장 개수가 정해지는데, standby 서버에 장애가 발생할 경우 만약 이 값이 32라면 master 서버에서 33번째 WAL을 쓰기 시작하면 1번째 파일은 유실되고, standby 서버가 다시 동작하더라도 데이터를 동기화 하는 방법은 다시 구축하는 방법 밖에는 없다.</li>
<li>위와 같은 상황을 방지하기 위해서 standby 서버로 보낼 WAL 파일을 그냥 버리지 않고, 별도의 공간에 저장 후 standby 서버에 장애가 발생했을 경우에 <a href="https://www.postgresql.org/docs/12/runtime-config-wal.html#GUC-RESTORE-COMMAND">restore command</a> 를 사용하여 복구 할 수 있다. 단, 별도의 저장공간이 필요하다.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Logical Replication</p>
<ul>
<li>변경된 데이터를 스트림으로 다른 서버로 보내며, 테이블 단위로 리플리케이션 될 수도 있다.</li>
<li><strong>N : N 의 구독자(subscribers) 와 게시자(publishers) 모델을 사용한다.</strong></li>
<li>일반적으로 게시자 데이터의 스냅샷을 만들어서 구독자에게 복사하는 것으로 리플리케이션이 시작되고 게시자의 변경 내용이 실시간으로 구독자에게 전송되어 게시자와 동일한 순서로 데이터를 적용한다.</li>
<li>
<p>활용 사례</p>
<ul>
<li>N 대의 서버가 게시자가 되고 1대의 서버가 구독자가 되어 여러 서버의 정보를 하나의 서버로 모아서 분석 목적으로 사용.</li>
<li>논리적인 형태의 복제이기 때문에 다른 플랫폼 postgres 인스턴스간의 복제(Linux -> Windows) 가능.</li>
</ul>
</li>
<li>구독자가 읽기 전용으로 사용되는 경우 충돌이 발생하지 않지만, 구독자가 동일한 테이블에 대한 쓰기를 수행하면 충돌이 발생할 수 있다.</li>
</ul>
</li>
<li>
<p>Trigger-Based Master-Standby Replication</p>
<ul>
<li>데이터 변경을 주 서버가 받아서 처리하고 비동기적으로 복제 서버에 보낸다.</li>
<li>테이블 단위로 컨트롤 가능</li>
<li>master 서버가 실행중인 동안 standby 서버는 hot standby 서버로 읽기 전용 조회에 응답 할 수 있고 여러 대의 standby 서버를 지원한다.</li>
<li>대기 서버를 비동기식으로 (일괄 적으로) 업데이트 하므로 장애 조치 중에 데이터가 손실 될 수 있다.</li>
<li>DDL replication 은 지원하지 않는다.</li>
</ul>
</li>
<li>
<p>Statement-Based Replication Middleware

  <a
    class="gatsby-resp-image-link"
    href="/static/5c836a58a71dfa57552d61c83a39f1ea/6783b/pg-pool.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 235px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 87.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADHUlEQVQ4y21T2W7TUBD13/DGD8AfwBcgeAAVqFgFAglRIUTFA12gmyhqkeAFIRUkVOClCmorigRNm7gJ2dMkjZPYWZq1sZ3EsX2Ya9duWjHRxPdenzlzZuaaA5lpmtANky3x9VcOl55v4d5cALend3BrisfdmR0MjfkwNG778KQfF0a9WPcXrRgWyziYcS6hbh/Mf0ni9OVVPFoIY/hlADemArj/OoShCR5XxnhcnSDycR6nLv7A0mrWJtT/Q2gcKvzJF/F4IYgXHyKWTy3FcPOVH3dmeEx/imHyYxTj5COLQWxHK1aMcVKhY87hoCXzbeTKCoSSYq1P2skYjh047vbjELgVqyMtyS44Q2tvtI6+foR1SB3njmVwSHWDAmuo1LtuSU5L6q0eNiM1qN3+sRhXIfvTCKz2DXTpWZf7WA9WUaZAh8wxl1TRLIxICTXTju2xwdCPq3d1bJU7yCk6Mm0NfqGBIO2zso5wrYd0S3MJa4T1ljqQuibiRPY7XSdcH/FGDyHCCu0+uKKsoUrqo4kMnswv49niN4QTexaBoumI1HsuYZ4SNnUaVFrA0zfLGH37HX/jGetdk5Ilmxo4iRES6A8fxZlrszj/8D38oYQFkns2yCU8IEID2ImkcPb6LM49eEfrXZcwQ++5iqqjQOUxW9sMYmTuM7qqfKjQQGKAUFL6KKk2dsMXsbCqYmNblJy1h6t0dGRbXcjNBtrtA2RyEiqtDkzDoGabiA6ULFGfRSpbJVyL8GlBtLDM2oTdZSWX1D5y1Eyl1cSm14t4MoVYSqCJGujQ5AZLFmkATGVZKiCVSkPIFSCIZexXKmioPWTZUKySFbuMnxsbWFlZgW972+4hlRxtHCksEtk+beORMCXfwtraGjweDzwUs1eqYk82SCGBCjK7pCakQh7CXgZSPg/nfiaaR4QFKrdKW00+AO/zIRIKIsD7kU0l6Q7D7mGZFAaqXVSplyx7lSqskbNEWZpavNE7NpQw9XS/Y1jEFQdPT9Y/i5CpYApFAot0hXJEwq4SO2POynaMfQ3i4TnDsHvJVIvWmuZAX8w/1UzqPgyF7t4AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="pg-pool"
        title=""
        src="/static/5c836a58a71dfa57552d61c83a39f1ea/6783b/pg-pool.png"
        srcset="/static/5c836a58a71dfa57552d61c83a39f1ea/772e8/pg-pool.png 200w,
/static/5c836a58a71dfa57552d61c83a39f1ea/6783b/pg-pool.png 235w"
        sizes="(max-width: 235px) 100vw, 235px"
      />
    </span>
  </span>
  
  </a>
    </p>
<ul>
<li><strong>미들웨어 프로그램이 모든 SQL 쿼리를 가로 채서 하나 또는 모든 서버로 보내며, 각 서버는 독립적으로 작동한다.</strong></li>
<li>모든 서버가 변경 사항을 수신 할 수 있도록 읽기 / 쓰기 쿼리를 모든 서버로 보낸다.</li>
<li>읽기 전용 쿼리는 단 하나의 서버로 전송해서 서버간 부하를 줄일 수 있다.</li>
<li>각 서버는 독립적으로 작동 하기 때문에 브로드 캐스트 시 random(), CURRENT_TIMESTAMP, sequence 와 같은 값은 각 서버마다 다를 수 있다.</li>
<li>
<p>모든 서버의 값을 동일하게 갖기 위한 방법1</p>
<ul>
<li>어플리케이션이 단일 서버에서 값을 조회해서 쓰기에 사용한다.</li>
</ul>
</li>
<li>
<p>모든 서버의 값을 동일하게 갖기 위한 방법2</p>
<ul>
<li>미들웨어는 데이터 수정 쿼리만 master 서버로 전송하고, 미들웨어가 아닌 일반적인 마스터 대기 복제를 통해 대기 서버로 전파한다.</li>
</ul>
</li>
<li>
<p><strong>주의 사항</strong></p>
<ul>
<li><strong>한 서버에서 트랜잭션이 시작되어 커밋 되었다면, 다른 모든 서버에서도 모두 커밋되어야 그 트랜잭션이 유효하다고 처리되어야한다.</strong></li>
<li><strong>특정 서버에서 롤백된다면, 그 트랜잭션은 모든 서버에서 롤백되어야한다.</strong></li>
<li>이것을 구현하기 위해서는 미들웨어가 2중 커밋(two-phase commit)을 이용한다.(postgreSQL의 PREPARE TRANSACTION, COMMIT PREPARED 명령)</li>
</ul>
</li>
<li>Pgpool-II 및 Continuous 텅스텐 은 이러한 유형의 복제에 해당한다.</li>
</ul>
</li>
<li>
<p>Asynchronous Multimaster Replication</p>
<ul>
<li>비동기 멀티 마스터 복제는 시간차를 두고 서로 통신하게 된다.</li>
<li>데이터가 충돌이 나면 사용자가 해결 할 수 있는 방법을 제공하거나, 충돌 해결 정책에 따라 자동으로 해결 할 수 있는 기능이 있어야 한다.</li>
<li>Bucardo 라는 제품이 있다.</li>
</ul>
</li>
<li>
<p>Synchronous Multimaster Replication</p>
<ul>
<li>동기식으로 작업하기 때문에 자료 변경이 빈번한 환경이라면, 단독 운영 서버 환경 보다 성능이 더 떨어질 수 있다.</li>
<li>PostgreSQL에서는 이 방식의 복제 기능은 제공하지 않는다.</li>
</ul>
</li>
<li><strong>기능 비교 표</strong>

  <a
    class="gatsby-resp-image-link"
    href="/static/685990b920f16562567bfee5b07d6336/9eaa0/table.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 42%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQoz2WSia6CUAxE+f8ve/4AIcYEkbCDsu9a76leY3wkTeu0zEyLjphn2zYZx5FSyrKUy+UicRxLEASSF4WcTifpuk7CMJQkSeTvcFDseDyK67o673menM+BOMMwyDRNcr/f5fF4KPk8LyZmFanrWolut5sKWEHy9XrVQIxZeJw8z/Vl+wC2bSsIkelBOvS9EoFBwBwkvcEJBBvTc1DP0lSapvmoQLIsL5c4X9dVndMDJ4N915CqwyzLpDB3wimENPd9/4Q9w2+mt5psawJxJUyNQ9YC0MG3I2pwPgS3iqJIVwPf3mR2zmanqiod4oXf5m4yN+MDcDfW4gzfZP8Ifd9//T3yQtfBnXVo7wTR+v7NFpbU9qltfgJb5WhVR0F6agAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="table"
        title=""
        src="/static/685990b920f16562567bfee5b07d6336/5a190/table.png"
        srcset="/static/685990b920f16562567bfee5b07d6336/772e8/table.png 200w,
/static/685990b920f16562567bfee5b07d6336/e17e5/table.png 400w,
/static/685990b920f16562567bfee5b07d6336/5a190/table.png 800w,
/static/685990b920f16562567bfee5b07d6336/c1b63/table.png 1200w,
/static/685990b920f16562567bfee5b07d6336/29007/table.png 1600w,
/static/685990b920f16562567bfee5b07d6336/9eaa0/table.png 1676w"
        sizes="(max-width: 800px) 100vw, 800px"
      />
    </span>
  </span>
  
  </a>
    </li>
</ul>
<h3>3. Write-Ahead Log Shipping</h3>
<ul>
<li>PostgreSQL Streaming Replication 은 기본이 비동기 방식이다.</li>
<li>동기식 복제 방식은 하나의 트랜잭션을 하나 이상의 standby 서버에 반영하고, 그 결과를 master 서버가 확인하는 방식이며, master, standby 서버 모두 트랜잭션이 트랜잭션 로그 파일에 기록 되었을 경우에만 정상처리 되었다고 판단한다.</li>
<li>동기식 복제 방식은 자료의 안정성을 제공하지만, standby 서버의 작업 완료 응답을 확인하는 작업까지 포함하므로 그 만큼의 지연시간이 생길 수 밖에 없다.</li>
<li>기본적인 WAL 파일을 이용한 복제는 다음과 같은 방식으로 동작하며, 본 글에서는 기본적인 streaming replication 을 설정하는 방법에 대해서만 다룬다.

  <a
    class="gatsby-resp-image-link"
    href="/static/366f968c72623e9599f20b816683ef95/cc155/wal-log-shipping.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 23%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABIklEQVQY022QzU7CUBCF+5Qu3brxXYwbn0CXosYFRCwaIRIRJbIQxQDFQgXaK/2Flrb38wpuNJ5kcubkzGQyR4uBMAM/yQlWElfxBjlpqlyZrpWbZISpJFDlGUPcbpdolfIX2nhsEfj+RsmMQC02Oy76rcFFtad4yEPnEy/+XpaEYcjB7g5721sUK49MvIwsTYjjmCRJ0PYPSxiWg++5XOu66qdUX545ubmi2KhTat7RHplYzpxKucxw0OdUr3F0VqQ38Wm9ThHCwbZtxQJNCHXdD1kuIvxPgYgWnFv3HJtVCmaNwqjGpdPGXSZ4yk/jiMbTG/VWl8EkwJx6v192lyuMD5v3mVAZqSxVjv9hvs44p2/N6JljRo5H9DMqc4mUm/oCTXtzVNwSiuwAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="log-shipping"
        title=""
        src="/static/366f968c72623e9599f20b816683ef95/5a190/wal-log-shipping.png"
        srcset="/static/366f968c72623e9599f20b816683ef95/772e8/wal-log-shipping.png 200w,
/static/366f968c72623e9599f20b816683ef95/e17e5/wal-log-shipping.png 400w,
/static/366f968c72623e9599f20b816683ef95/5a190/wal-log-shipping.png 800w,
/static/366f968c72623e9599f20b816683ef95/cc155/wal-log-shipping.png 886w"
        sizes="(max-width: 800px) 100vw, 800px"
      />
    </span>
  </span>
  
  </a>
    </li>
</ul>
<h4>3.1. postgresql 9.6 / 12 차이점 비교</h4>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/b5891c01fbeeaf9fbd8417febd57ccac/6da96/change-list.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 25.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA9UlEQVQY01WQ2aqDYAyEff/XUcSl2sVSqqKtKOJS64ogKm4PMCW5OHAuPhIy/2TCL1iWBVEUIUkSFEWBpmn/KunP5xOPxwO32w2qqjKk08y2ba66ruN8PkNI0xSu6+J6vcLzPHy/X3Rdh6qq4DgO3u83933f/xHHMYd8Ph80TYOyLNG2LYZhgEBD3/fZSIspYJomFqMoYsIw5CAyzvPMPb0NgoA1CiAfhQl5nuP1erFIZkqq65pNp9OJuVwuzP1+Z53CZVmGYRiMaZrsz7IMAm2lJkkSvmpdV2YcRxRFwRfRxVSXZcG+7/wl5KM5QW+3bcNxHPgBMBhc2VuD0FMAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="change-list"
        title=""
        src="/static/b5891c01fbeeaf9fbd8417febd57ccac/5a190/change-list.png"
        srcset="/static/b5891c01fbeeaf9fbd8417febd57ccac/772e8/change-list.png 200w,
/static/b5891c01fbeeaf9fbd8417febd57ccac/e17e5/change-list.png 400w,
/static/b5891c01fbeeaf9fbd8417febd57ccac/5a190/change-list.png 800w,
/static/b5891c01fbeeaf9fbd8417febd57ccac/6da96/change-list.png 922w"
        sizes="(max-width: 800px) 100vw, 800px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h4>3.2. docker container 생성</h4>
<ul>
<li>아래부터 진행되는 모든 과정은 docker container 환경에서 테스트를 진행한다. 테스트에 사용한 이미지는 centos8.1 이미지에 postgresql12.3 을 설치하여 테스트 하였다.</li>
<li>
<p>master container 생성</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker container run --privileged -d -p <span class="token number">25432</span>:5432 --name <span class="token string">"master"</span> gaia3d/mago3d-postgresql /sbin/init</code></pre></div>
</li>
<li>
<p>slave container 생성</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker container run --privileged -d -p <span class="token number">25433</span>:5432 --name <span class="token string">"slave"</span> gaia3d/mago3d-postgresql /sbin/init</code></pre></div>
</li>
<li>
<p>container에 연결 하기</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker <span class="token builtin class-name">exec</span> -it master <span class="token function">bash</span></code></pre></div>
</li>
</ul>
<h4>3.3. master 서버 설정</h4>
<ul>
<li>master 서버의 설정은 크게 replication role 을 가진 유저를 생성하고, standby 서버가 master 서버에 접근하기 위한 보안 설정과 replication을 위한 설정 3가지로 나눌 수 있다.</li>
<li>
<p>replicator 역할의 유저 생성</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">    <span class="token function">su</span> postgres
    psql -U postgres</code></pre></div>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql">    <span class="token keyword">CREATE</span> <span class="token keyword">USER</span> replicator <span class="token keyword">WITH</span> <span class="token keyword">REPLICATION</span> ENCRYPTED PASSWORD <span class="token string">'secret'</span><span class="token punctuation">;</span></code></pre></div>
<ul>
<li>user가 정상적으로 생성되었는지 확인(\du)

  <a
    class="gatsby-resp-image-link"
    href="/static/9378eb66ac0b5aa26e62eca79a925560/0f79a/user-list.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 689px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 21%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAnElEQVQY0z1Qyw6AIAzjhgQxQRQROAh40v//vpkumYdmz7Td1Pu+9DwPjTHoPE/a952O46CUEucxRtq2jXuosZNzZqAHYMday1C1VgJKKdyYpomMMRwB7z0TgmyeZ9Ja/zOBc46WZeG5ghOQQSWEQOu6MkCAiDnc3/fNbkAuAuK8tcYcEFfXdf3LvXfO4VhOBKmIyTskyrmocR0cfqLKY5S4KInCAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="user-list"
        title=""
        src="/static/9378eb66ac0b5aa26e62eca79a925560/0f79a/user-list.png"
        srcset="/static/9378eb66ac0b5aa26e62eca79a925560/772e8/user-list.png 200w,
/static/9378eb66ac0b5aa26e62eca79a925560/e17e5/user-list.png 400w,
/static/9378eb66ac0b5aa26e62eca79a925560/0f79a/user-list.png 689w"
        sizes="(max-width: 689px) 100vw, 689px"
      />
    </span>
  </span>
  
  </a>
    </li>
</ul>
</li>
<li>
<p>pg.hba.conf 설정</p>
<ul>
<li>type / database / user / address / method(인증방식) 을 작성 후 저장후 postgresql 을 재시작한다.</li>
<li><strong>address 는 standby 서버의 ip 를 작성하도록 한다.</strong></li>
<li>
<p>docker 를 사용해서 테스트 할 경우 container 의 ip 를 작성하도록 한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">host</span>    replication     replicator      standbyIP/32             md5</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">systemctl restart postgresql-12</code></pre></div>
</li>
</ul>
</li>
<li>
<p>postgresql.conf 설정</p>
<ul>
<li>
<p>wal_level(enum)</p>
<ul>
<li>WAL 파일에 기록되는 정보의 양을 결정한다. 기본값은 replica 로 WAL 아카이빙(archive mode) 및 streaming replication 을 위해서는 replica 이상을 사용해야 한다.</li>
<li>9.6 이전 버전에서는 archive, hot_standby 두 값을 쓸 수 있었으며, 12버전에서는 이 설정값을 사용 시 모두 replica로 처리 된다.</li>
</ul>
</li>
<li>
<p>max<em>wal</em>senders(integer)</p>
<ul>
<li>standby 서버 또는 streaming 기본 백업 클라이언트로부터의 최대 동시 연결수를 지정한다. (기본값 : 10)</li>
<li>이 값이 0일 경우는 replication 이 비활성화 된다.</li>
<li>일반적으로 standby 서버의 개수 +1 개로 설정한다.</li>
</ul>
</li>
<li>
<p>wal<em>keep</em>segments(integer)</p>
<ul>
<li>standby 서버가 streaming replication을 위해 과거 로그 파일을 가져와야 하는 경우 pg_wal 디렉토리에 저장되는 과거 로그 파일 세그먼트의 최소 수를 지정하며, 각 세그먼트는 일반적으로 16MB 이다.</li>
<li>wal segment 가 너무 빨리 갱신 되어 빠른 속도로 사라지게 되고, standby 서버에 기록되는 wal segment 가 master 서버의 wal 갱신 속도를 따라가지 못하면 replication이 중단 된다.</li>
</ul>
</li>
<li>
<p>wal<em>sender</em>timeout(integer)</p>
<ul>
<li>
<p>지정된 시간 이상 작동되지 않은 복제 연결이 중단 된다. 기본값은 60초이고, 0일 경우 비활성화 된다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">wal_level <span class="token operator">=</span> replica
max_wal_senders <span class="token operator">=</span> <span class="token number">2</span>
wal_keep_segments <span class="token operator">=</span> <span class="token number">32</span>
wal_sender_timeout <span class="token operator">=</span> 60s</code></pre></div>
</li>
</ul>
</li>
<li>
<p>설정 파일 저장후 pg 재시작</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">systemctl restart postgresql-12</code></pre></div>
</li>
</ul>
</li>
</ul>
<h4>3.4 Standby 서버 설정</h4>
<ul>
<li>pg_basebackup 으로 master db 를 복사할때 옵션을 사용해서 자동으로 replication 설정을 할 수 있다. <strong>ip 는 master 의 ip를 써준다.</strong></li>
<li>-D : 복사할 data 경로를 지정한다. (postgresql data 파일 경로로 지정해야 한다.)</li>
<li>-Xs : wal 파일을 stream 방식으로 쓴다.</li>
<li>-P : 진행사항을 표시한다.</li>
<li>
<p><strong>-R : replication 을 위한 설정을 적용한다.</strong></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pg_basebackup -h masterIP -U replicator -p <span class="token number">5432</span> -D /pg_data -Xs -P -R</code></pre></div>
</li>
<li>
<p>root 계정으로 복사 했으므로 data 경로의 권한은 postgres로 변경해준다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">chown</span> -R postgres:postgres /pg_data</code></pre></div>
</li>
<li>
<p>standby 서버 실행</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">systemctl start postgresql-12</code></pre></div>
</li>
<li>data 폴더에 standby.signal 파일이 있는지와 postgresql.auto.conf 파일에 master 의 정보가 정상적으로 작성되었는지 확인한다.

  <a
    class="gatsby-resp-image-link"
    href="/static/a2c1f668ea07582d96af0aceb8bad620/41d3c/standby-signal.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 490px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 87.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACxUlEQVQ4y2WUyU5bQRBFH5jJiNmYwYBtBo/gAStWZuVT2GLLGyRAIASImT9ghyVYsCARhIQVW34l33FTp5UOOFmUqru6+ta9Ve91sLa2Jmxzc1M7Ozva3t7WxsaGW+O3trZ0cHDg1uvr69rd3XX5q6urqtfrqtVqajQaWllZ0fPzs4Kuri6Fw2Hhh4eH1dfX59ajo6Pq6Ohw+/n5eY2MjGhwcFBjY2Pq7+93Z1goFHL5QRDo4uJCAQnj4+OanJxULpdTsVhUJpNRoVBQPp/X1NSUSqWSstmsksmk0um0iy8tLSkejyuRSGh2dtYBNptNBYBNTEy4yj55bm7O+VQqpZmZGQc+PT3tjDiMFxYWnApUgQHg5eWlAgLIARAgD4KnOqxgyJo4YMRYx2IxB0or/gLCjgrRaNTJgg1gSEI6ciqVimsHoDDjnCIYqoaGhl4APTsqcZkLVMd7VlykXz4OQ3IxehyJRF4AAfKgMIQJ0vH+MoB4egg74uSyBrCFIZKZMIBIXFxcdH3CcwHwarXqQGCJRNZ48rnX0kOGAmUOvGSYeMmAvGZIDmsKYfT/P4b+W0Tmv0PhEkPxvYUZ5yhANupaGNJDADGk+s+Gi/6jRTLA7MmBtZ82hAYGBlqnjPHZkARLQKjOHga+nxTybSFWLpfdUFoAXw8FEKT6C0jmzP96MHRT/jM0WEOmBZChIDtqRrNfD8V/e2UDhJlnSB7SKcb9mHkeiaurK3sc+FPsF4qaz1rV4vKy0gzH5ORtQHED8DHWGfuXfV7ZhpVClT0oQXu7mtfXCkptbaoYesEov+vp0Sd7mqqdnfpoz9aH3l6lLf7enreqPVFv7Ln6bPLYf7HJkvO2u1tVs6jl3Z2eKrjd39fXvT19M/9wcqKfFnw4Pnb+h9mtPaj3h4duj78/OtJ3s8fzc5f3eHamO9vf2AP86+lJvwGQTirzGqM4HAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="standby-signal"
        title=""
        src="/static/a2c1f668ea07582d96af0aceb8bad620/41d3c/standby-signal.png"
        srcset="/static/a2c1f668ea07582d96af0aceb8bad620/772e8/standby-signal.png 200w,
/static/a2c1f668ea07582d96af0aceb8bad620/e17e5/standby-signal.png 400w,
/static/a2c1f668ea07582d96af0aceb8bad620/41d3c/standby-signal.png 490w"
        sizes="(max-width: 490px) 100vw, 490px"
      />
    </span>
  </span>
  
  </a>
    </li>
</ul>
<h4>3.5 테스트</h4>
<ul>
<li>테스트는 master 에 테이블을 하나 생성하고 insert 쿼리 후 standby 서버에 정상적으로 반영이 되는지 확인한다.</li>
<li>
<p>master</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">    <span class="token function">su</span> postgres
    psql -U postgres</code></pre></div>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql">    <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test <span class="token punctuation">(</span>id <span class="token keyword">serial</span><span class="token punctuation">,</span> name <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'tester'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
</li>
<li>
<p>standby</p>
<ul>
<li>
<p><strong>postgres 9.6 의 경우는 postgresql.conf 파일의 hot_standby 기본 옵션이 ‘off’ 로 되어 있어 psql 사용이 불가능하다. 해당 옵션을 on으로 변경후 pg를 재시작후 테스트를 하도록 한다.</strong></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">su</span> postgres
psql -U postgres</code></pre></div>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test<span class="token punctuation">;</span></code></pre></div>
</li>
</ul>
</li>
</ul>
<h4>3.6. 모니터링</h4>
<ul>
<li>
<p>master 에서는 walsender 가 standby 에서는 walreceiver 가 잘 실행되고 있는지 확인한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -ef <span class="token operator">|</span> <span class="token function">grep</span> wal</code></pre></div>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/aef5391570648df75f574097c2743f36/14060/wal-check.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 16.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAl0lEQVQI112JTQqEMAxGez+1yhQregBP0IWliBTqMfynrrzjN01gXEzg8fIS0fc92rZF13VomoZdVRWUUqjrmv0pU6ebLCXyPEeWZYyUEkVRvNZaQ9z3jW3bEGPEdV349b7vvEeC7onzPHEcx/unXpYF67qyqUUIAd57zPPMJsZxxDRNcM7BWgs7DMxATk1/Ywye58H/fAGQbJjrDUhE3AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="wal-check"
        title=""
        src="/static/aef5391570648df75f574097c2743f36/5a190/wal-check.png"
        srcset="/static/aef5391570648df75f574097c2743f36/772e8/wal-check.png 200w,
/static/aef5391570648df75f574097c2743f36/e17e5/wal-check.png 400w,
/static/aef5391570648df75f574097c2743f36/5a190/wal-check.png 800w,
/static/aef5391570648df75f574097c2743f36/14060/wal-check.png 949w"
        sizes="(max-width: 800px) 100vw, 800px"
      />
    </span>
  </span>
  
  </a>
    </p>
</li>
<li>master 에서는 pg<em>stat</em>replication 을 standby 에서는 pg<em>stat</em>wal_receiver view를 각각 psql로 조회해본다.

  <a
    class="gatsby-resp-image-link"
    href="/static/08fc516e549bb7ec8e827f534fe85c2a/68947/pg-stat.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 23.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAtklEQVQY01WOOQqAUAxEf2/jissBFHE5ifs13BDBynOr3UgCEX/xmMlMAlHHcYDY9x3btmFdVyzLwkzT9Pl5njUVZH8cR5znCeX7PqIoQhAECMOQsSyLcV2X8TwPtm3DNM0v+3eO48AwDCRJAnXfN57n0aBMuK5LQ7J/J55uVd/3GIYBXdehrms0TcNaVRVr27acEeRlh3qZyUum8jxHlmX8bpqmKIqCVTxRlqWmciMZ7dIcxzFeT8LZAMR92MwAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;"
        alt="pg-stat"
        title=""
        src="/static/08fc516e549bb7ec8e827f534fe85c2a/5a190/pg-stat.png"
        srcset="/static/08fc516e549bb7ec8e827f534fe85c2a/772e8/pg-stat.png 200w,
/static/08fc516e549bb7ec8e827f534fe85c2a/e17e5/pg-stat.png 400w,
/static/08fc516e549bb7ec8e827f534fe85c2a/5a190/pg-stat.png 800w,
/static/08fc516e549bb7ec8e827f534fe85c2a/c1b63/pg-stat.png 1200w,
/static/08fc516e549bb7ec8e827f534fe85c2a/68947/pg-stat.png 1281w"
        sizes="(max-width: 800px) 100vw, 800px"
      />
    </span>
  </span>
  
  </a>
    </li>
<li>master 서버에서 select pg<em>current</em>wal<em>lsn(); 쿼리 결과의 값이 pg</em>stat<em>replication view 를 조회한 값중 sent</em>lsn 값과 차이가 많이 나면
master 서버가 부하가 많이 걸리거나 네트워크 상황이 좋지 않은 경우이고, standby 서버에서 select pg<em>last</em>wal<em>receive</em>lsn();
쿼리 결과의 값이 sent_lsn 값과 차이가 많이 나면 standby 서버가 부하가 많이 걸리거나 네트워크 상황이 좋지 않은 경우이다.</li>
</ul>
<h3>4. 장애 처리</h3>
<ul>
<li>streaming replication 은 수동으로 standby 서버를 master 서버로 승격시켜주고 연결된 application 의 db 접속 정보를 변경해 주어야 한다. 자동 장애 처리를 위해서는 pg-pool2 와 같은 미들웨어를 사용해야 한다.</li>
<li>
<p>standby 서버 master 서버로 승격</p>
<ul>
<li>
<p><strong>pg_ctl promote</strong> 호출하거나 postgresql.conf 파일에 <strong>promote<em>trigger</em>file</strong> 파일을 작성하면 된다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">su</span> postgres
./usr/pgsql-12/bin/pg_ctl promote -D /pg_data/</code></pre></div>
</li>
<li>data 경로에 standby.siganl 파일이 사라졌는지 확인한다.</li>
</ul>
</li>
<li>
<p>새로운 master 서버 pg_hba.conf 파일 수정</p>
<ul>
<li>
<p>장애 서버에서 새로운 master 서버의 데이터를 복사하기 위해 장애 서버의 접근을 허용해준다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">host</span>    replication     replicator      장애서버IP/32             md5</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">systemctl restart postgresql-12</code></pre></div>
</li>
</ul>
</li>
<li>
<p>장애 서버 standby 서버로 변경</p>
<ul>
<li>
<p>기존 데이터 디렉토리를 백업하고 pg_basebackup 으로 새로운 master 서버의 DB를 복사한다.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mv</span> /pg_data /pg_backup
pg_basebackup -h 새로운masterIP -U replicator -p <span class="token number">5432</span> -D /pg_data  -Xs -P -R</code></pre></div>
</li>
<li>
<p>postgresql 시작</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">systemctl restart postgresql-12</code></pre></div>
<p>3.5 테스트과정을 반복한다.</p>
</li>
</ul>
</li>
</ul></div><footer><div class="author"><div class="avatar"><img src="https://avatars.githubusercontent.com/u/6446144?v=4" alt="삽질저장소"/></div><div class="note"><p><strong>OpenSesame</strong></p>
<ul>
<li>안되면 될 때 까지!</li>
<li>무분별한 정보 보다는 정확한 정보를 전달하도록 노력하기.</li>
</ul></div></div><div class="links"><a href="/thymeleaf/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg><h4>springBoot Thymeleaf<!-- --> <time>2020-06-03<!-- --> </time></h4></a><a href="/docker-with-centos-postgres/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"></path></svg><h4>centos8 postgresql12&amp;postgis 설치하기<!-- --> <time>2020-04-26</time></h4></a></div></footer></article></main><footer class="footer"><ul>
<li>Thank You for Visiting My Blog, Have a Good Day 😆 <br />© 2021 Developer <a href="https://github.com/">shPark</a>, Powered By Gatsby.</li>
</ul></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/postgresql-high-availability/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-16797aeb1857e4bdc070.js"],"app":["/app-12eff7a04d58f71d6664.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-36dc033f967ae9fe9cda.js"],"component---src-pages-404-js":["/component---src-pages-404-js-29ccc9f03a886ed7280f.js"],"component---src-pages-category-js":["/component---src-pages-category-js-59a162261b03ed3f2568.js"],"component---src-pages-index-js":["/component---src-pages-index-js-2cb867cd2168e8eadcc9.js"],"component---src-pages-search-js":["/component---src-pages-search-js-d6c22e90e502c95f5fcc.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-3180f369f1d32d0f3a3e.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-67b3bc047f385a030f3d.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-b9b09e01660a2cb702b9.js"]};/*]]>*/</script><script src="/polyfill-16797aeb1857e4bdc070.js" nomodule=""></script><script src="/component---src-templates-post-template-js-b9b09e01660a2cb702b9.js" async=""></script><script src="/3df72598ed628fa3b584613cd093848b9c087970-7e8ab1b1cd93282549c1.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-12eff7a04d58f71d6664.js" async=""></script><script src="/1bfc9850-d06e3c25ea137ea82c47.js" async=""></script><script src="/framework-acd7498685eeb36e39da.js" async=""></script><script src="/webpack-runtime-3d61ad746ed8c6156b20.js" async=""></script></body></html>